{% extends "crm/base.html" %}
{% load humanize %}

{% block title %}Buyurtmalar{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
  <h4 class="mb-0">Buyurtmalar</h4>
  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-sm btn-outline-primary" href="{% url 'crm_export_report_pdf' %}">Hisobot PDF</a>
    <form method="get" class="d-flex gap-2">
      <select name="status" class="form-select form-select-sm">
        <option value="">Barchasi</option>
        {% for value, label in statuses %}
        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <button class="btn btn-sm btn-outline-secondary" type="submit">Filter</button>
    </form>
  </div>
</div>

<div class="card crm-card p-3">
  <table class="table crm-table align-middle">
    <thead>
      <tr>
        <th>ID</th>
        <th>Mijoz</th>
        <th>Telefon</th>
        <th>Summa</th>
        <th>Kanal</th>
        <th>Status</th>
        <th>Kuryer</th>
        <th>Amal</th>
      </tr>
    </thead>
    <tbody>
      {% for order in orders %}
      <tr>
        <td>#{{ order.id }}</td>
        <td>{{ order.full_name }}</td>
        <td>{{ order.phone }}</td>
        <td>{{ order.total_price|floatformat:0|intcomma }}</td>
        <td>{{ order.get_order_source_display }}</td>
        <td>{{ order.get_status_display }}</td>
        <td>{{ order.courier|default:"â€”" }}</td>
        <td>
          {% if order.order_source != "pos" %}
          <form method="post" class="d-flex flex-wrap gap-2">
            {% csrf_token %}
            <input type="hidden" name="order_id" value="{{ order.id }}">
            <input type="hidden" name="action" value="status">
            <select name="status" class="form-select form-select-sm">
              {% for value, label in statuses %}
              <option value="{{ value }}" {% if order.status == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-sm btn-outline-primary" type="submit">Yangilash</button>
          </form>
          <form method="post" class="d-flex flex-wrap gap-2 mt-2">
            {% csrf_token %}
            <input type="hidden" name="order_id" value="{{ order.id }}">
            <input type="hidden" name="action" value="assign">
            <select name="courier_id" class="form-select form-select-sm">
              <option value="">Kuryer tanlang</option>
              {% for courier in couriers %}
              <option value="{{ courier.id }}">{{ courier.name }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-sm btn-outline-success" type="submit">Biriktirish</button>
          </form>
          {% else %}
          <span class="text-muted small">POS (offline)</span>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="8" class="text-muted">Buyurtmalar yo'q</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% extends "crm/base.html" %}
{% load humanize %}

{% block title %}CRM Dashboard{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
  <h4 class="mb-0">Dashboard</h4>
  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-sm btn-outline-primary" href="{% url 'crm_export_report_pdf' %}">Hisobot PDF</a>
  </div>
</div>
<div class="row g-4 mb-4">
  <div class="col-md-3">
    <div class="card crm-card p-3">
      <div class="text-muted small">Bugungi buyurtmalar</div>
      <div class="crm-kpi">{{ orders_today }}</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card crm-card p-3">
      <div class="text-muted small">Bugungi tushum</div>
      <div class="crm-kpi">{{ revenue_today|floatformat:0|intcomma }} so'm</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card crm-card p-3">
      <div class="text-muted small">Jami buyurtmalar</div>
      <div class="crm-kpi">{{ total_orders }}</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card crm-card p-3">
      <div class="text-muted small">Jami tushum</div>
      <div class="crm-kpi">{{ total_revenue|floatformat:0|intcomma }} so'm</div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-6">
    <div class="card crm-card p-3">
      <div class="fw-semibold mb-2">Eng ko'p sotilgan kitoblar</div>
      <table class="table crm-table mb-0">
        <thead>
          <tr>
            <th>Kitob</th>
            <th class="text-end">Soni</th>
            <th class="text-end">Tushum</th>
          </tr>
        </thead>
        <tbody>
          {% for item in top_books %}
          <tr>
            <td>{{ item.book__title }}</td>
            <td class="text-end">{{ item.quantity }}</td>
            <td class="text-end">{{ item.revenue|intcomma }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="3" class="text-muted">Ma'lumot yo'q</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card crm-card p-3">
      <div class="fw-semibold mb-2">Eng faol mijozlar</div>
      <table class="table crm-table mb-0">
        <thead>
          <tr>
            <th>Mijoz</th>
            <th class="text-end">LTV</th>
            <th class="text-end">Buyurtmalar</th>
          </tr>
        </thead>
        <tbody>
          {% for customer in top_customers %}
          <tr>
            <td>{{ customer.full_name }}</td>
            <td class="text-end">{{ customer.total_spent|intcomma }}</td>
            <td class="text-end">{{ customer.orders_count }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="3" class="text-muted">Ma'lumot yo'q</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card crm-card p-3">
      <div class="fw-semibold mb-2">Kuryerlar samaradorligi</div>
      <table class="table crm-table mb-0">
        <thead>
          <tr>
            <th>Kuryer</th>
            <th class="text-end">Buyurtmalar</th>
          </tr>
        </thead>
        <tbody>
          {% for courier in courier_stats %}
          <tr>
            <td>{{ courier.courier__name }}</td>
            <td class="text-end">{{ courier.total }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="2" class="text-muted">Ma'lumot yo'q</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card crm-card p-3 mt-4">
  <div class="fw-semibold mb-2">Ma'lumotlar bazasini tozalash</div>
  <form method="post" action="{% url 'crm_cleanup' %}" class="row g-2 align-items-end">
    {% csrf_token %}
    <div class="col-md-4">
      <label class="form-label">Necha kundan eski</label>
      <input type="number" name="days" class="form-control" value="90" min="0" max="3650">
    </div>
    <div class="col-md-4">
      <label class="form-label">Qaysi buyurtmalar</label>
      <select name="scope" class="form-select">
        <option value="closed">Yopilgan/Bekor qilingan</option>
        <option value="all">Barchasi (to'langan ham)</option>
      </select>
      <div class="text-muted small mt-1">Tanlovga ko'ra buyurtmalar va ombor yozuvlari o'chiriladi.</div>
    </div>
    <div class="col-md-4">
      <div class="form-check mt-4">
        <input class="form-check-input" type="checkbox" value="1" id="force_all" name="force_all">
        <label class="form-check-label" for="force_all">
          Hammasini o'chirish (faqat buyurtmalar)
        </label>
      </div>
      <button class="btn btn-danger w-100 mt-2" type="submit">Tozalash</button>
    </div>
  </form>
</div>
{% endblock %}
